<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Analyst Dashboard - ASA Data Server</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/table.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .analytics-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .summary-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    .summary-value {
      font-size: 32px;
      font-weight: bold;
      color: #9b59b6;
    }

    .welcome-section {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .welcome-section h1 {
      margin: 0 0 10px 0;
    }

    .welcome-section p {
      margin: 0;
      opacity: 0.9;
    }

    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      height: 350px;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-container canvas {
      max-height: 280px;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="nav-brand">
      <h2>üèõÔ∏è ASA Analytics Portal</h2>
      <p style="font-size: 12px; margin: 0; color: #ddd;" id="analystName">Data Analyst</p>
    </div>
    <ul class="nav-menu">
      <li><a href="analyst-dashboard.html" class="active">üìä Dashboard</a></li>
      <li><a href="predictions-functional.html">üîÆ Predictions</a></li>
      <li><a href="price-history-functional.html">üìä Price History</a></li>
      <li><a href="fraud-alerts-functional.html">‚ö†Ô∏è Fraud Alerts</a></li>
      <li><a href="stocks-functional.html">üìà Stocks</a></li>
      <li><a href="companies-functional.html">üè¢ Companies</a></li>
      <li><a href="transactions-functional.html">üí∞ Transactions</a></li>
      <li><a href="trades-functional.html">üîÑ Trades</a></li>
      <li><a href="investors-functional.html">üë§ Investors</a></li>
      <li><a href="#" class="logout" onclick="handleLogout(); return false;">üö™ Logout</a></li>
    </ul>
  </nav>

  <div class="main-content">
    <div class="welcome-section">
      <h1>Welcome back, <span id="welcomeName">Data Analyst</span>!</h1>
      <p>Advanced Analytics & Predictive Modeling Portal</p>
    </div>

    <div class="analytics-summary">
      <div class="summary-card">
        <h3>Active Predictions</h3>
        <div class="summary-value" id="activePredictions">0</div>
      </div>
      <div class="summary-card">
        <h3>Model Accuracy</h3>
        <div class="summary-value" id="modelAccuracy">94.2%</div>
      </div>
      <div class="summary-card">
        <h3>Fraud Patterns Detected</h3>
        <div class="summary-value" id="fraudPatterns">0</div>
      </div>
      <div class="summary-card">
        <h3>Data Points Analyzed</h3>
        <div class="summary-value" id="dataPoints">0</div>
      </div>
    </div>

    <div class="chart-grid">
      <div class="chart-container">
        <h3>Market Trends</h3>
        <canvas id="marketTrendsChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>Prediction Accuracy</h3>
        <canvas id="accuracyChart"></canvas>
      </div>
    </div>

    <div class="page-header">
      <h2>Recent Predictions</h2>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Prediction ID</th>
            <th>Stock ID</th>
            <th>Current Price</th>
            <th>Predicted Price</th>
            <th>Confidence</th>
            <th>Model</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="predictionsBody">
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="page-header" style="margin-top: 40px;">
      <h2>Fraud Detection Alerts</h2>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Alert ID</th>
            <th>Transaction ID</th>
            <th>Alert Type</th>
            <th>Severity</th>
            <th>Confidence</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="fraudAlertsBody">
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="js/local-database.js"></script>
  <script>
    // Check if analyst is logged in
    const userRole = sessionStorage.getItem('userRole');
    const analystName = sessionStorage.getItem('userFullName') || 'Demo Data Analyst';
    const isLoggedIn = sessionStorage.getItem('isLoggedIn');

    if (!isLoggedIn || userRole !== 'analyst') {
      window.location.href = 'login.html';
    }

    // Display analyst name
    document.getElementById('analystName').textContent = analystName;
    document.getElementById('welcomeName').textContent = analystName;

    // Load analyst data
    const predictionsDb = new LocalDatabase('predictions');
    const fraudAlertsDb = new LocalDatabase('fraud_alerts');
    const stocksDb = new LocalDatabase('stocks');
    const transactionsDb = new LocalDatabase('transactions');

    let marketTrendsChart = null;
    let accuracyChart = null;

    function loadDashboard() {
      const predictions = predictionsDb.getAll();
      const fraudAlerts = fraudAlertsDb.getAll();
      const stocks = stocksDb.getAll();
      const transactions = transactionsDb.getAll();

      // Calculate stats
      const activePredictions = predictions.filter(p => p.status === 'Active').length;
      const fraudPatterns = fraudAlerts.filter(f => f.status === 'Active').length;
      const dataPoints = stocks.length + transactions.length + predictions.length;

      document.getElementById('activePredictions').textContent = activePredictions;
      document.getElementById('fraudPatterns').textContent = fraudPatterns;
      document.getElementById('dataPoints').textContent = dataPoints.toLocaleString();

      // Display recent predictions
      renderPredictions(predictions.slice(0, 10));

      // Display recent fraud alerts
      renderFraudAlerts(fraudAlerts.slice(0, 10));

      // Render charts
      renderMarketTrendsChart();
      renderAccuracyChart();
    }

    function renderPredictions(predictions) {
      const tbody = document.getElementById('predictionsBody');

      if (predictions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No predictions found</td></tr>';
        return;
      }

      tbody.innerHTML = predictions.map(prediction => {
        const stock = stocksDb.getAll().find(s => s.id == prediction.stock_id);
        const currentPrice = parseFloat(stock?.current_price || 0);
        const predictedPrice = parseFloat(prediction.predicted_price);

        return `
                <tr>
                    <td>PR-${prediction.id}</td>
                    <td>${prediction.stock_id}</td>
                    <td>$${currentPrice.toFixed(2)}</td>
                    <td>$${predictedPrice.toFixed(2)}</td>
                    <td>${prediction.confidence_level}%</td>
                    <td><span class="badge" style="background: #9b59b6; color: white;">${prediction.model_used}</span></td>
                    <td>${new Date(prediction.prediction_date).toLocaleDateString()}</td>
                </tr>
                `;
      }).join('');
    }

    function renderFraudAlerts(alerts) {
      const tbody = document.getElementById('fraudAlertsBody');

      if (alerts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No fraud alerts found</td></tr>';
        return;
      }

      tbody.innerHTML = alerts.map(alert => `
                <tr>
                    <td>FA-${alert.id}</td>
                    <td>${alert.transaction_id}</td>
                    <td>${alert.alert_type}</td>
                    <td><span style="color: ${alert.severity === 'High' ? '#e74c3c' : alert.severity === 'Medium' ? '#f39c12' : '#27ae60'}; font-weight: bold;">${alert.severity}</span></td>
                    <td>85%</td>
                    <td><span class="badge badge-${alert.status.toLowerCase().replace(' ', '-')}">${alert.status}</span></td>
                </tr>
            `).join('');
    }

    function renderMarketTrendsChart() {
      const ctx = document.getElementById('marketTrendsChart').getContext('2d');

      if (marketTrendsChart) {
        marketTrendsChart.destroy();
      }

      // Generate sample trend data
      const labels = [];
      const data = [];
      for (let i = 30; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString());
        data.push(Math.random() * 100 + 50);
      }

      marketTrendsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Market Index',
            data: data,
            borderColor: '#9b59b6',
            backgroundColor: 'rgba(155, 89, 182, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: false
            }
          }
        }
      });
    }

    function renderAccuracyChart() {
      const ctx = document.getElementById('accuracyChart').getContext('2d');

      if (accuracyChart) {
        accuracyChart.destroy();
      }

      accuracyChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Accurate', 'Inaccurate'],
          datasets: [{
            data: [94.2, 5.8],
            backgroundColor: ['#9b59b6', '#ecf0f1'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    function handleLogout() {
      sessionStorage.clear();
      window.location.href = 'login.html';
    }

    // Load dashboard on page load
    loadDashboard();
  </script>
</body>

</html>