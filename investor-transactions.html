<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Transactions - ASA Investor Portal</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/table.css">
  <link rel="stylesheet" href="css/modal.css">
</head>

<body>
  <nav class="navbar">
    <div class="nav-brand">
      <h2>ğŸ›ï¸ ASA Investor Portal</h2>
      <p style="font-size: 12px; margin: 0; color: #ddd;" id="investorName">Investor</p>
    </div>
    <ul class="nav-menu">
      <li><a href="investor-dashboard.html">ğŸ“Š Dashboard</a></li>
      <li><a href="stocks-functional.html">ğŸ“ˆ Stocks</a></li>
      <li><a href="companies-functional.html">ğŸ¢ Companies</a></li>
      <li><a href="price-history-functional.html">ğŸ“Š Price History</a></li>
      <li><a href="predictions-functional.html">ğŸ”® Predictions</a></li>
      <li><a href="investor-transactions.html" class="active">ğŸ’° My Transactions</a></li>
      <li><a href="investor-trades.html">ğŸ”„ My Trades</a></li>
      <li><a href="investor-profile.html">ğŸ‘¤ My Profile</a></li>
      <li><a href="#" class="logout" onclick="handleLogout(); return false;">ğŸšª Logout</a></li>
    </ul>
  </nav>

  <div class="main-content">
    <div class="page-header">
      <h1>ğŸ’° My Transactions</h1>
      <p>View and manage your stock transactions</p>
    </div>

    <div class="table-controls">
      <div class="search-box">
        <input type="text" placeholder="Search transactions..." id="searchInput">
        <button class="btn-search" onclick="handleSearch()">Search</button>
      </div>
      <div class="action-buttons">
        <button class="btn-add" onclick="openAddModal()">+ New Transaction</button>
      </div>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Transaction ID</th>
            <th>Type</th>
            <th>Investor Name</th>
            <th>Shares</th>
            <th>Price per Share</th>
            <th>Total Amount</th>
            <th>Transaction Date</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add Transaction Modal -->
  <div id="transactionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">New Transaction</h2>
        <span class="close" onclick="closeModal('transactionModal')">&times;</span>
      </div>
      <div class="modal-body">
        <form id="transactionForm">
          <div class="form-group">
            <label for="transaction_type">Type *</label>
            <select id="transaction_type" required>
              <option value="BUY">BUY</option>
              <option value="SELL">SELL</option>
            </select>
          </div>

          <div class="form-group">
            <label for="shares">Shares *</label>
            <input type="number" id="shares" required min="1" oninput="calculateTotal()">
          </div>

          <div class="form-group">
            <label for="price_per_share">Price per Share *</label>
            <input type="number" id="price_per_share" required step="0.01" min="0" oninput="calculateTotal()">
          </div>

          <div class="form-group">
            <label for="total_amount">Total Amount</label>
            <input type="number" id="total_amount" step="0.01" readonly style="background: #f5f5f5;">
          </div>

          <div class="form-group">
            <label for="transaction_date">Transaction Date *</label>
            <input type="date" id="transaction_date" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('transactionModal')">Cancel</button>
        <button class="btn btn-primary" onclick="handleSave()">Save</button>
      </div>
    </div>
  </div>

  <script src="js/local-database.js"></script>
  <script>
    // Check authentication
    const isLoggedIn = sessionStorage.getItem('isLoggedIn');
    const userRole = sessionStorage.getItem('userRole');
    const investorId = sessionStorage.getItem('investorId') || '20001';
    const investorName = sessionStorage.getItem('userFullName') || 'Demo Investor';

    if (!isLoggedIn || userRole !== 'investor') {
      window.location.href = 'login.html';
    }

    document.getElementById('investorName').textContent = investorName;

    const db = new LocalDatabase('transactions');

    function loadTransactions() {
      const allTransactions = db.getAll();
      const myTransactions = allTransactions.filter(t => t.investor_id == investorId);
      renderTable(myTransactions);
    }

    function renderTable(transactions) {
      const tbody = document.getElementById('tableBody');

      if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No transactions found</td></tr>';
        return;
      }

      tbody.innerHTML = transactions.map(tx => `
                <tr>
                    <td>${tx.id}</td>
                    <td><span class="badge" style="background: ${tx.transaction_type === 'BUY' ? '#28a745' : '#dc3545'}; color: white;">${tx.transaction_type}</span></td>
                    <td>${tx.investor_name}</td>
                    <td>${parseInt(tx.shares).toLocaleString()}</td>
                    <td>$${parseFloat(tx.price_per_share).toFixed(2)}</td>
                    <td><strong>$${parseFloat(tx.total_amount).toFixed(2)}</strong></td>
                    <td>${tx.transaction_date || '-'}</td>
                </tr>
            `).join('');
    }

    function handleSearch() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      const allTransactions = db.getAll();
      const myTransactions = allTransactions.filter(t => t.investor_id == investorId);

      if (query.trim() === '') {
        renderTable(myTransactions);
      } else {
        const filtered = myTransactions.filter(t =>
          JSON.stringify(t).toLowerCase().includes(query)
        );
        renderTable(filtered);
      }
    }

    function calculateTotal() {
      const shares = parseFloat(document.getElementById('shares').value) || 0;
      const price = parseFloat(document.getElementById('price_per_share').value) || 0;
      document.getElementById('total_amount').value = (shares * price).toFixed(2);
    }

    function openAddModal() {
      document.getElementById('transactionForm').reset();
      document.getElementById('transaction_date').value = new Date().toISOString().split('T')[0];
      openModal('transactionModal');
    }

    function handleSave() {
      const data = {
        transaction_type: document.getElementById('transaction_type').value,
        investor_id: investorId,
        investor_name: investorName,
        shares: document.getElementById('shares').value,
        price_per_share: document.getElementById('price_per_share').value,
        total_amount: document.getElementById('total_amount').value,
        transaction_date: document.getElementById('transaction_date').value
      };

      db.add(data);
      alert('Transaction added successfully!');
      closeModal('transactionModal');
      loadTransactions();
    }

    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function handleLogout() {
      sessionStorage.clear();
      window.location.href = 'login.html';
    }

    window.onclick = function (event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }

    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleSearch();
      }
    });

    loadTransactions();
  </script>
</body>

</html>