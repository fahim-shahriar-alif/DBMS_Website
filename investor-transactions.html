<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Transactions - Investor Portal</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/table.css">
</head>

<body>
  <nav class="navbar">
    <div class="nav-brand">
      <h2>üë§ Investor Portal</h2>
      <p style="font-size: 12px; margin: 0; color: #ddd;" id="investorName">Welcome, Investor</p>
    </div>
    <ul class="nav-menu">
      <li><a href="dashboard-investor.html">üìä Dashboard</a></li>
      <li><a href="investor-portfolio.html">üíº My Portfolio</a></li>
      <li><a href="investor-transactions.html" class="active">üí∞ My Transactions</a></li>
      <li><a href="investor-stocks.html">üìà Browse Stocks</a></li>
      <li><a href="#" class="logout" onclick="handleLogout(); return false;">üö™ Logout</a></li>
    </ul>
  </nav>

  <div class="main-content">
    <div class="page-header">
      <h1>üí∞ My Transactions</h1>
      <p>View your transaction history and pending requests</p>
    </div>

    <div class="stats-grid" style="margin-bottom: 30px;">
      <div class="stat-card">
        <div class="stat-icon blue">üí∞</div>
        <div class="stat-info">
          <h3>Total Transactions</h3>
          <p class="stat-number" id="totalTransactions">0</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">‚úÖ</div>
        <div class="stat-info">
          <h3>Completed</h3>
          <p class="stat-number" id="completedTransactions">0</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon orange">‚è≥</div>
        <div class="stat-info">
          <h3>Pending</h3>
          <p class="stat-number" id="pendingTransactions">0</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon purple">üíµ</div>
        <div class="stat-info">
          <h3>Total Volume</h3>
          <p class="stat-number" id="totalVolume">$0</p>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Transaction ID</th>
            <th>Date</th>
            <th>Type</th>
            <th>Stock</th>
            <th>Company</th>
            <th>Quantity</th>
            <th>Price/Share</th>
            <th>Total Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px;">Loading transactions...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="js/local-database.js"></script>
  <script src="js/logout.js"></script>
  <script>
    // Check if user is logged in and has Investor role
    window.addEventListener('DOMContentLoaded', () => {
      const isLoggedIn = localStorage.getItem('isLoggedIn');
      const userRole = localStorage.getItem('userRole');
      const userFullName = localStorage.getItem('userFullName');

      if (!isLoggedIn || userRole !== 'Investor') {
        window.location.href = 'login.html';
        return;
      }

      // Display investor name
      document.getElementById('investorName').textContent = `Welcome, ${userFullName}`;

      // Load transactions
      loadTransactions();
    });

    function loadTransactions() {
      const userId = localStorage.getItem('userId');
      const transactionsDb = new LocalDatabase('stock_transactions');
      const stocksDb = new LocalDatabase('stocks');
      const companiesDb = new LocalDatabase('companies');

      // Get only this investor's transactions
      const transactions = transactionsDb.getAll()
        .filter(tx => tx.investor_id == userId)
        .sort((a, b) => new Date(b.transaction_date) - new Date(a.transaction_date));

      // Update stats
      updateStats(transactions);

      // Render table
      renderTable(transactions, stocksDb, companiesDb);
    }

    function updateStats(transactions) {
      const totalTransactions = transactions.length;
      const completedTransactions = transactions.filter(tx => tx.status === 'Completed').length;
      const pendingTransactions = transactions.filter(tx => tx.status === 'Pending').length;
      const totalVolume = transactions.reduce((sum, tx) => sum + parseFloat(tx.total_amount || 0), 0);

      document.getElementById('totalTransactions').textContent = totalTransactions;
      document.getElementById('completedTransactions').textContent = completedTransactions;
      document.getElementById('pendingTransactions').textContent = pendingTransactions;
      document.getElementById('totalVolume').textContent = '$' + totalVolume.toLocaleString();
    }

    function renderTable(transactions, stocksDb, companiesDb) {
      const tbody = document.getElementById('tableBody');

      if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">No transactions found. Submit a Buy/Sell request from the Dashboard.</td></tr>';
        return;
      }

      tbody.innerHTML = transactions.map(tx => {
        const stock = stocksDb.getById(tx.stock_id);
        const company = companiesDb.getById(tx.company_id);

        const stockSymbol = stock ? stock.symbol : 'Unknown';
        const companyName = company ? company.company_name : 'Unknown Company';

        const typeClass = tx.transaction_type === 'Buy' ? 'badge-success' : 'badge-warning';
        const statusClass = tx.status === 'Completed' ? 'badge-success' :
          tx.status === 'Pending' ? 'badge-warning' : 'badge-danger';

        return `
                    <tr>
                        <td>TX-${tx.id}</td>
                        <td>${new Date(tx.transaction_date).toLocaleDateString()}</td>
                        <td><span class="badge ${typeClass}">${tx.transaction_type}</span></td>
                        <td><strong>${stockSymbol}</strong></td>
                        <td>${companyName}</td>
                        <td>${parseInt(tx.quantity).toLocaleString()}</td>
                        <td>$${parseFloat(tx.price_per_share).toFixed(2)}</td>
                        <td><strong>$${parseFloat(tx.total_amount).toLocaleString()}</strong></td>
                        <td><span class="badge ${statusClass}">${tx.status}</span></td>
                    </tr>
                `;
      }).join('');
    }
  </script>
</body>

</html>