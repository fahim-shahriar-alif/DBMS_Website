<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Data Provider Dashboard - ASA Data Server</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/table.css">
  <style>
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 25px;
      border-radius: 10px;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-card.purple {
      background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
    }

    .stat-card.blue {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }

    .stat-card.green {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      opacity: 0.9;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      margin: 10px 0;
    }

    .stat-card .change {
      font-size: 12px;
      opacity: 0.8;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .action-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .action-card:hover {
      border-color: #8e44ad;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .action-card .icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .action-card h4 {
      margin: 0;
      color: #2c3e50;
    }

    .data-feeds {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .feed-item {
      padding: 15px;
      border-bottom: 1px solid #ecf0f1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .feed-item:last-child {
      border-bottom: none;
    }

    .feed-icon {
      font-size: 24px;
      margin-right: 15px;
    }

    .feed-details {
      flex: 1;
    }

    .feed-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-active {
      background: #d5f4e6;
      color: #27ae60;
    }

    .status-updating {
      background: #fef9e7;
      color: #f39c12;
    }

    .status-error {
      background: #fadbd8;
      color: #e74c3c;
    }

    .price-updates {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .price-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #ecf0f1;
    }

    .price-item:last-child {
      border-bottom: none;
    }

    .price-change-positive {
      color: #27ae60;
      font-weight: bold;
    }

    .price-change-negative {
      color: #e74c3c;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="nav-brand">
      <h2>ğŸ›ï¸ ASA Market Data Portal</h2>
      <p style="font-size: 12px; margin: 0; color: #ddd;" id="marketDataName">Market Data Provider</p>
    </div>
    <ul class="nav-menu">
      <li><a href="market-data-dashboard.html" class="active">ğŸ“Š Dashboard</a></li>
      <li><a href="price-history-functional.html">ğŸ“Š Price History</a></li>
      <li><a href="stocks-functional.html">ğŸ“ˆ Stocks</a></li>
      <li><a href="companies-functional.html">ğŸ¢ Companies</a></li>
      <li><a href="transactions-functional.html">ğŸ’° Transactions</a></li>
      <li><a href="trades-functional.html">ğŸ”„ Trades</a></li>
      <li><a href="investors-functional.html">ğŸ‘¤ Investors</a></li>
      <li><a href="institutions-functional.html">ğŸ›ï¸ Institutions</a></li>
      <li><a href="#" class="logout" onclick="handleLogout()">ğŸšª Logout</a></li>
    </ul>
  </nav>

  <div class="main-content">
    <div class="welcome-section">
      <h1>Welcome back, <span id="welcomeName">Market Data Provider</span>!</h1>
      <p>Market Data & Price Management Portal</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card purple">
        <h3>ğŸ“Š Price Updates</h3>
        <div class="value" id="priceUpdates">0</div>
        <div class="change">Today's updates</div>
      </div>

      <div class="stat-card blue">
        <h3>ğŸ“ˆ Tracked Stocks</h3>
        <div class="value" id="trackedStocks">0</div>
        <div class="change">Active stocks</div>
      </div>

      <div class="stat-card green">
        <h3>ğŸ¢ Companies</h3>
        <div class="value" id="totalCompanies">0</div>
        <div class="change">Market listings</div>
      </div>

      <div class="stat-card">
        <h3>âš¡ Data Feeds</h3>
        <div class="value" id="activeFeeds">3</div>
        <div class="change">Active feeds</div>
      </div>
    </div>

    <div class="quick-actions">
      <div class="action-card" onclick="window.location.href='price-history-functional.html'">
        <div class="icon">ğŸ“Š</div>
        <h4>Update Prices</h4>
        <p style="font-size: 12px; color: #7f8c8d; margin: 5px 0 0 0;">Record price changes</p>
      </div>

      <div class="action-card" onclick="window.location.href='stocks-functional.html'">
        <div class="icon">ğŸ“ˆ</div>
        <h4>Manage Stocks</h4>
        <p style="font-size: 12px; color: #7f8c8d; margin: 5px 0 0 0;">Update stock information</p>
      </div>

      <div class="action-card" onclick="window.location.href='companies-functional.html'">
        <div class="icon">ğŸ¢</div>
        <h4>Company Data</h4>
        <p style="font-size: 12px; color: #7f8c8d; margin: 5px 0 0 0;">Update market data</p>
      </div>

      <div class="action-card" onclick="window.location.href='transactions-functional.html'">
        <div class="icon">ğŸ’°</div>
        <h4>View Transactions</h4>
        <p style="font-size: 12px; color: #7f8c8d; margin: 5px 0 0 0;">Monitor market activity</p>
      </div>
    </div>

    <div class="data-feeds">
      <h2 style="margin-top: 0;">âš¡ Data Feed Status</h2>
      <div class="feed-item">
        <span class="feed-icon">ğŸ“¡</span>
        <div class="feed-details">
          <strong>Real-time Price Feed</strong>
          <p style="margin: 5px 0 0 0; font-size: 14px; color: #7f8c8d;">Live market data stream</p>
        </div>
        <span class="feed-status status-active">ACTIVE</span>
      </div>
      <div class="feed-item">
        <span class="feed-icon">ğŸ“ˆ</span>
        <div class="feed-details">
          <strong>Historical Data Sync</strong>
          <p style="margin: 5px 0 0 0; font-size: 14px; color: #7f8c8d;">Batch price history updates</p>
        </div>
        <span class="feed-status status-updating">UPDATING</span>
      </div>
      <div class="feed-item">
        <span class="feed-icon">ğŸ¢</span>
        <div class="feed-details">
          <strong>Company Information Feed</strong>
          <p style="margin: 5px 0 0 0; font-size: 14px; color: #7f8c8d;">Corporate data synchronization</p>
        </div>
        <span class="feed-status status-active">ACTIVE</span>
      </div>
    </div>

    <div class="price-updates">
      <h2 style="margin-top: 0;">ğŸ“Š Recent Price Updates</h2>
      <div id="recentPriceUpdates">
        <div class="price-item">
          <div>
            <strong>AAPL</strong>
            <p style="margin: 0; font-size: 12px; color: #7f8c8d;">Apple Inc.</p>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 18px; font-weight: bold;">$150.25</div>
            <div class="price-change-positive">+2.5%</div>
          </div>
        </div>
        <div class="price-item">
          <div>
            <strong>GOOGL</strong>
            <p style="margin: 0; font-size: 12px; color: #7f8c8d;">Alphabet Inc.</p>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 18px; font-weight: bold;">$2,750.80</div>
            <div class="price-change-negative">-1.2%</div>
          </div>
        </div>
        <div class="price-item">
          <div>
            <strong>MSFT</strong>
            <p style="margin: 0; font-size: 12px; color: #7f8c8d;">Microsoft Corp.</p>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 18px; font-weight: bold;">$305.15</div>
            <div class="price-change-positive">+0.8%</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/local-database.js"></script>
  <script>
    // Check if market data provider is logged in
    const userRole = sessionStorage.getItem('userRole');
    const marketDataName = sessionStorage.getItem('userFullName') || 'Market Data Provider';
    const isLoggedIn = sessionStorage.getItem('isLoggedIn');

    if (!isLoggedIn || userRole !== 'market-data') {
      window.location.href = 'login.html';
    }

    // Display market data provider name
    document.getElementById('marketDataName').textContent = marketDataName;
    document.getElementById('welcomeName').textContent = marketDataName;

    // Load market data
    const stocksDb = new LocalDatabase('stocks');
    const companiesDb = new LocalDatabase('companies');
    const priceHistoryDb = new LocalDatabase('price_history');

    function loadDashboardData() {
      const stocks = stocksDb.getAll();
      const companies = companiesDb.getAll();
      const priceHistory = priceHistoryDb.getAll();

      // Update stats
      document.getElementById('trackedStocks').textContent = stocks.length;
      document.getElementById('totalCompanies').textContent = companies.length;

      // Count today's price updates
      const today = new Date().toISOString().split('T')[0];
      const todayUpdates = priceHistory.filter(ph => {
        const phDate = new Date(ph.date).toISOString().split('T')[0];
        return phDate === today;
      }).length;
      document.getElementById('priceUpdates').textContent = todayUpdates;

      // Load recent price updates
      loadRecentPriceUpdates(stocks, priceHistory);
    }

    function loadRecentPriceUpdates(stocks, priceHistory) {
      if (stocks.length === 0) return;

      // Get recent price updates
      const recentUpdates = stocks.slice(0, 5).map(stock => {
        // Find latest price history for this stock
        const stockPrices = priceHistory
          .filter(ph => ph.stock_id === stock.id)
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        let priceChange = 0;
        if (stockPrices.length >= 2) {
          const latest = parseFloat(stockPrices[0].closing_price);
          const previous = parseFloat(stockPrices[1].closing_price);
          priceChange = ((latest - previous) / previous * 100);
        }

        return {
          symbol: stock.symbol,
          company_name: stock.company_name,
          current_price: stock.current_price,
          change: priceChange
        };
      });

      const updatesContainer = document.getElementById('recentPriceUpdates');
      updatesContainer.innerHTML = recentUpdates.map(update => {
        const changeClass = update.change >= 0 ? 'price-change-positive' : 'price-change-negative';
        const changeSymbol = update.change >= 0 ? '+' : '';

        return `
          <div class="price-item">
            <div>
              <strong>${update.symbol}</strong>
              <p style="margin: 0; font-size: 12px; color: #7f8c8d;">${update.company_name}</p>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 18px; font-weight: bold;">$${parseFloat(update.current_price).toFixed(2)}</div>
              <div class="${changeClass}">${changeSymbol}${update.change.toFixed(1)}%</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function handleLogout() {
      sessionStorage.clear();
      window.location.href = 'login.html';
    }

    // Load data on page load
    loadDashboardData();

    // Simulate real-time updates every 30 seconds
    setInterval(() => {
      loadDashboardData();
    }, 30000);
  </script>
</body>

</html>